import{G as ve,o as he,H as ye,c as z,w as s,a as o,I as we,y as w,t as _e,z as be,d as g,e as n,K as j,L as D,M as H,g as r,V as W,q as I,i as d,W as ke,X as S,D as A,l as m,p as v,f as Y,Y as Ie,Z as Ae,s as C,r as Ce,n as Re,_ as xe,m as h,v as Se,$ as Ee}from"./index-vCZlUi6s.js";import{L as f}from"./leaflet-src-C8Aqtbpj.js";import"./leaflet.markercluster-src-NIqeFdU9.js";import{u as Te,a as Le}from"./useGeolocation-Dbssxn1j.js";import{u as Me}from"./reports.store-CFG89qXN.js";import{R as $e,a as Q,b as Oe,c as ze}from"./constants-CKzTGXC9.js";import{_ as De}from"./_plugin-vue_export-helper-DlAUqK2U.js";import"./useSignalements-Bl-XL2BA.js";const Be={class:"map-controls"},Pe={key:0,class:"loading-overlay"},Ne={class:"report-details"},Fe={class:"report-header"},Ue={class:"report-title-section"},Ve={class:"report-meta"},Ze={class:"report-address"},qe={class:"report-date"},Ge={key:0,class:"report-category"},je={key:1,class:"report-description"},He={class:"report-details-grid"},We={key:0,class:"detail-item"},Ye={key:2,class:"report-photos"},Qe={class:"photo-carousel"},Je={class:"photo-container"},Ke=["src"],Xe={key:0,class:"photo-counter"},et={class:"report-actions"},tt={__name:"MainMapScreen",setup(ot){const R=Te(),p=Me(),{getCurrentPosition:J}=Le(),x=w(null);let i=null,y=null,_=null;const E=w(!1),B=w("all"),L=w(!1),l=w(null),M=w(!0),b=w(typeof navigator<"u"?navigator.onLine:!0),T=be(()=>p.filteredReports),K=()=>{E.value=!E.value},X=e=>{const t=e.detail.value;p.setFilters({status:t})},ee=async()=>{if(x.value)try{if(!b.value){await k("La carte requiert une connexion internet active","warning"),M.value=!1;return}const e=x.value.getBoundingClientRect();(e.width===0||e.height===0)&&(console.warn("‚ö†Ô∏è Conteneur de carte non dimensionn√©, attente..."),await new Promise(t=>setTimeout(t,200))),delete f.Icon.Default.prototype._getIconUrl,f.Icon.Default.mergeOptions({iconRetinaUrl:"https://unpkg.com/leaflet@1.9.4/dist/images/marker-icon-2x.png",iconUrl:"https://unpkg.com/leaflet@1.9.4/dist/images/marker-icon.png",shadowUrl:"https://unpkg.com/leaflet@1.9.4/dist/images/marker-shadow.png"}),i=f.map(x.value,{center:R.center,zoom:R.zoom,zoomControl:!1,attributionControl:!0,scrollWheelZoom:!0,dragging:!0,touchZoom:!0,doubleClickZoom:!1,updateWhenIdle:!0,preferCanvas:!0,fadeAnimation:!1,zoomAnimation:!0}),console.log("‚úÖ Carte Leaflet initialis√©e avec succ√®s"),f.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png",{maxZoom:18,maxNativeZoom:18,attribution:"&copy; OpenStreetMap contributors",errorTileUrl:"data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7",keepBuffer:2,updateInterval:200,noWrap:!0,crossOrigin:"anonymous"}).addTo(i),console.log("‚úÖ Tuiles OpenStreetMap charg√©es");try{_=f.markerClusterGroup({chunkedLoading:!0,spiderfyOnMaxZoom:!0,showCoverageOnHover:!1,zoomToBoundsOnClick:!0,removeOutsideVisibleBounds:!0,animate:!1,maxClusterRadius:60,disableClusteringAtZoom:17,iconCreateFunction:t=>{const a=t.getChildCount();let u="small",c=25;return a>20?(u="large",c=35):a>10&&(u="medium",c=30),f.divIcon({html:`<div class="cluster cluster-${u}"><span>${a}</span></div>`,className:"cluster-icon",iconSize:[c*2,c*2],iconAnchor:[c,c]})}}),i.addLayer(_),console.log("‚úÖ Groupe de clusters cr√©√© et ajout√©")}catch(t){console.error("‚ö†Ô∏è Erreur cluster, utilisation de marqueurs simples:",t),_=null}R.setMapInstance(i),await te();try{await J(),console.log("‚úÖ Position utilisateur obtenue")}catch(t){console.warn("‚ö†Ô∏è Erreur g√©olocalisation:",t)}i.on("moveend",P),i.on("zoomend",P),console.log("‚úÖ Tous les √©v√©nements de carte enregistr√©s")}catch(e){console.error("‚ùå ERREUR CRITIQUE lors de l'initialisation de la carte:",e),console.error("Stack:",e.stack),await k(`Erreur carte: ${e.message||"Erreur inconnue"}`,"danger")}finally{M.value=!1}},P=()=>{if(!i)return;const e=i.getCenter(),t=i.getZoom();R.setCenter([e.lat,e.lng]),R.setZoom(t)},te=async()=>{try{console.log("üì° Chargement des signalements..."),console.log("üìä Avant fetch - reports:",p.reports.length),await p.fetchReports(),console.log("üìä Apr√®s fetch - reports.value:",p.reports.length),console.log("üìä Apr√®s fetch - filteredReports:",T.value.length),console.log("üìÑ D√©tails des signalements:",JSON.stringify(p.reports.map(e=>{var t;return{id:e.id,lat:e.latitude,lng:e.longitude,desc:(t=e.description)==null?void 0:t.substring(0,20)}}))),p.reports.length===0&&console.warn("‚ö†Ô∏è Aucun signalement disponible"),N()}catch(e){console.error("‚ùå Erreur lors du chargement des signalements:",e),await k("Erreur lors du chargement des signalements","danger")}},N=()=>{if(!i){console.warn("‚ö†Ô∏è updateMarkers: Carte non initialis√©e");return}try{if(_){_.clearLayers();let e=0;T.value.forEach(t=>{const a=F(t);a&&(_.addLayer(a),e++)}),console.log(`‚úÖ ${e} marqueurs ajout√©s au cluster`)}else y&&i.removeLayer(y),y=f.featureGroup(),T.value.forEach(e=>{const t=F(e);t&&y.addLayer(t)}),y.getLayers().length>0&&(i.addLayer(y),console.log(`‚úÖ ${y.getLayers().length} marqueurs ajout√©s (sans clustering)`))}catch(e){console.error("‚ùå Erreur lors de la mise √† jour des marqueurs:",e)}},F=e=>{try{if(!e.latitude||!e.longitude)return console.warn("‚ö†Ô∏è Marqueur sans coordonn√©es valides:",e),null;const t=se(e),a=f.divIcon(t),u=f.marker([e.latitude,e.longitude],{icon:a}),c=`
      <div class="marker-popup">
        <h4>${e.description||e.title||"Sans description"}</h4>
        <p class="address">üìç ${e.address||"Position: "+e.latitude.toFixed(4)+", "+e.longitude.toFixed(4)}</p>
        <div class="status">
          <span class="badge" style="background-color: ${$e[e.status]||"#999"}">
            ${Q[e.status]||e.status}
          </span>
        </div>
        <p class="type"><strong>Type:</strong> ${V(e)} ${Z(e)}</p>
        <button class="details-btn" onclick="window.showReportDetails('${e.id}')">
          Voir d√©tails
        </button>
      </div>
    `;return u.bindPopup(c),u.on("click",()=>{de(e.id)}),u}catch(t){return console.error(`‚ùå Erreur cr√©ation marqueur pour ${e==null?void 0:e.title}:`,t),null}},oe=e=>e?{"!":"‚ö†Ô∏è",car:"üöó",check:"‚úì",wrench:"üîß",water:"üíß",checkered:"üèÅ"}[e]||e:null,U=e=>{if(e==null)return null;if(typeof e=="number")return e;const t=Number(e);return Number.isFinite(t)?t:null},V=(e,t=null)=>{var G;const a=(e==null?void 0:e.type)||null,u=typeof a=="string"?a:((a==null?void 0:a.libelle)||(a==null?void 0:a.label)||(e==null?void 0:e.category)||(e==null?void 0:e.typeLabel)||((G=e==null?void 0:e.type)==null?void 0:G.libelle)||"").toString(),c=U((a==null?void 0:a.id)||(a==null?void 0:a.typeId)||(e==null?void 0:e.typeId)||(e==null?void 0:e.type_id)||(e==null?void 0:e.type)||t),$={"Probl√®me critique":"‚ö†Ô∏è","Travaux en cours":"üöó","Probl√®me r√©solu":"‚úì","Alerte signal√©e":"‚ö†Ô∏è","Infrastructure endommag√©e":"üîß","Probl√®me d'inondation":"üíß","Chauss√©e d√©grad√©e":"üèÅ"},O={1:"‚ö†Ô∏è",2:"üöó",3:"‚úì",4:"‚ö†Ô∏è",5:"üîß",6:"üíß",7:"üèÅ"};return u&&$[u]?$[u]:c&&O[c]?O[c]:oe((a==null?void 0:a.icon_symbol)||(a==null?void 0:a.iconSymbol))||"‚ö†Ô∏è"},ne=e=>e?typeof e=="string"&&e.startsWith("#")?e:{red:"#dc3545",purple:"#6f42c1",green:"#28a745",yellow:"#ffc107",orange:"#fd7e14",blue:"#007bff","red-white":"#dc3545"}[e]||"#6c757d":"#6c757d",ae=e=>({1:"#dc3545",2:"#6f42c1",3:"#28a745",4:"#ffc107",5:"#fd7e14",6:"#007bff",7:"#dc3545",8:"#666666",9:"#DD0000",10:"#999999"})[e]||"#6c757d",se=e=>{const t=(e==null?void 0:e.type)||null,a=U((t==null?void 0:t.id)||(t==null?void 0:t.typeId)||(e==null?void 0:e.typeId)||(e==null?void 0:e.type_id)||(e==null?void 0:e.type));if(!t&&!a)return{html:`<div style="
        width: 40px;
        height: 40px;
        background-color: #6c757d;
        border: 3px solid white;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        box-shadow: 0 3px 6px rgba(0,0,0,0.4);
        font-size: 18px;
      ">‚ö†Ô∏è</div>`,className:"custom-marker",iconSize:[40,40],iconAnchor:[20,20],popupAnchor:[0,-20]};const u=ne((t==null?void 0:t.icon_color)||(t==null?void 0:t.iconColor))||ae(a),c=V(e,a);return{html:`<div style="
      width: 40px;
      height: 40px;
      ${((t==null?void 0:t.icon_symbol)||(t==null?void 0:t.iconSymbol))==="checkered"?`background: repeating-linear-gradient(
        45deg,
        ${u},
        ${u} 5px,
        white 5px,
        white 10px
      );`:`background-color: ${u};`}
      border: 3px solid white;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      box-shadow: 0 3px 6px rgba(0,0,0,0.4);
      font-size: 18px;
    ">${c}</div>`,className:"custom-marker",iconSize:[40,40],iconAnchor:[20,20],popupAnchor:[0,-20]}},Z=e=>{var u;const t=e==null?void 0:e.type;if(t!=null&&t.libelle)return t.libelle;const a=(e==null?void 0:e.typeId)||((u=e==null?void 0:e.type)==null?void 0:u.id);return a?`Type #${a}`:"‚Äî"},le=e=>({new:"danger",in_progress:"warning",completed:"success"})[e]||"primary",re=e=>Q[e]||e,ie=e=>Oe[e]||"help-circle",ue=e=>ze[e]||e,ce=e=>new Date(e).toLocaleDateString("fr-FR",{day:"numeric",month:"long",year:"numeric"});window.showReportDetails=e=>{const t=p.reports.find(a=>a.id===e);t&&(l.value=t,L.value=!0)};const de=e=>{window.showReportDetails(e)},q=()=>{L.value=!1,l.value=null},me=()=>{i&&i.zoomIn()},ge=()=>{i&&i.zoomOut()},fe=async()=>{if(!l.value)return;const e=l.value,t={title:`Signalement: ${e.title}`,text:`${e.description}

Adresse: ${e.address}`,url:window.location.origin};try{navigator.share?await navigator.share(t):(await navigator.clipboard.writeText(`${t.title}
${t.text}`),await k("Informations copi√©es dans le presse-papiers","success"))}catch(a){console.error("Erreur lors du partage:",a),await k("Erreur lors du partage","danger")}},pe=()=>{if(!l.value)return;const e=l.value,t=`https://www.openstreetmap.org/directions?from=&to=${e.latitude},${e.longitude}`;window.open(t,"_blank")},k=async(e,t="primary")=>{await(await _e.create({message:e,duration:3e3,color:t,position:"top"})).present()};return ve(T,N),he(async()=>{console.log("üì± MainMapScreen mont√©e"),typeof window<"u"&&typeof navigator<"u"&&(window.addEventListener("online",()=>{b.value=!0,console.log("üü¢ En ligne")}),window.addEventListener("offline",()=>{b.value=!1,console.log("üî¥ Hors ligne")})),console.log("üîç √âtat r√©seau initial:",b.value),console.log("üîç Conteneur de carte:",x.value);try{await ee(),console.log("‚úÖ MainMapScreen pr√™te")}catch(e){console.error("‚ùå Erreur fatale au montage:",e),await k("Erreur d'initialisation de la carte","danger")}}),ye(()=>{i&&(i.remove(),i=null)}),(e,t)=>(g(),z(o(we),null,{default:s(()=>[n(o(j),null,{default:s(()=>[n(o(D),null,{default:s(()=>[n(o(H),null,{default:s(()=>[...t[1]||(t[1]=[r("span",{class:"app-logo"},"ROAD ALERT",-1),r("span",{class:"title-sep"},"‚Ä¢",-1),r("span",{class:"app-title"},"Carte des Signalements",-1)])]),_:1}),n(o(W),{slot:"end"},{default:s(()=>[n(o(I),{onClick:K,class:"filter-button"},{default:s(()=>[n(o(d),{name:"filter",color:E.value?"primary":"medium"},null,8,["color"])]),_:1})]),_:1})]),_:1}),E.value?(g(),z(o(D),{key:0,class:"filters-toolbar"},{default:s(()=>[n(o(ke),{modelValue:B.value,"onUpdate:modelValue":t[0]||(t[0]=a=>B.value=a),onIonChange:X,scrollable:"",class:"filters-segment"},{default:s(()=>[n(o(S),{value:"all"},{default:s(()=>[n(o(A),null,{default:s(()=>[...t[2]||(t[2]=[m("Tous",-1)])]),_:1})]),_:1}),n(o(S),{value:"new"},{default:s(()=>[n(o(A),null,{default:s(()=>[...t[3]||(t[3]=[m("Nouveaux",-1)])]),_:1})]),_:1}),n(o(S),{value:"in_progress"},{default:s(()=>[n(o(A),null,{default:s(()=>[...t[4]||(t[4]=[m("En cours",-1)])]),_:1})]),_:1}),n(o(S),{value:"completed"},{default:s(()=>[n(o(A),null,{default:s(()=>[...t[5]||(t[5]=[m("Termin√©s",-1)])]),_:1})]),_:1}),n(o(S),{value:"mine"},{default:s(()=>[n(o(A),null,{default:s(()=>[...t[6]||(t[6]=[m("Mes signalements",-1)])]),_:1})]),_:1})]),_:1},8,["modelValue"])]),_:1})):v("",!0)]),_:1}),n(o(Y),{fullscreen:!0,class:"map-content"},{default:s(()=>[r("div",{ref_key:"mapContainer",ref:x,class:"map-container"},null,512),r("div",Be,[n(o(I),{fill:"solid",shape:"round",onClick:me,class:"control-button"},{default:s(()=>[n(o(d),{name:"add"})]),_:1}),n(o(I),{fill:"solid",shape:"round",onClick:ge,class:"control-button"},{default:s(()=>[n(o(d),{name:"remove"})]),_:1})]),n(o(Ie),{vertical:"bottom",horizontal:"start",slot:"fixed",class:"report-fab"},{default:s(()=>[n(o(Ae),{"router-link":"/report/new",color:"secondary"},{default:s(()=>[n(o(d),{name:"add"})]),_:1})]),_:1}),M.value?(g(),C("div",Pe,[n(o(Ce),{name:"crescent",color:"primary"}),t[7]||(t[7]=r("p",null,"Chargement de la carte...",-1))])):v("",!0),r("div",{class:Re(["status-indicator",{offline:!b.value}])},[n(o(d),{name:b.value?"wifi":"cloud-offline"},null,8,["name"])],2)]),_:1}),n(o(xe),{"is-open":L.value,onDidDismiss:q,class:"report-modal"},{default:s(()=>[n(o(j),null,{default:s(()=>[n(o(D),null,{default:s(()=>[n(o(H),null,{default:s(()=>[...t[8]||(t[8]=[r("span",{class:"app-logo"},"ROAD ALERT",-1),r("span",{class:"title-sep"},"‚Ä¢",-1),r("span",{class:"app-title"},"D√©tails du signalement",-1)])]),_:1}),n(o(W),{slot:"end"},{default:s(()=>[n(o(I),{onClick:q},{default:s(()=>[n(o(d),{name:"close"})]),_:1})]),_:1})]),_:1})]),_:1}),l.value?(g(),z(o(Y),{key:0},{default:s(()=>[r("div",Ne,[r("div",Fe,[r("div",Ue,[r("h2",null,h(l.value.description||l.value.title||"Sans description"),1),n(o(Se),{color:le(l.value.status)},{default:s(()=>[m(h(re(l.value.status)),1)]),_:1},8,["color"])]),r("div",Ve,[r("p",Ze,[n(o(d),{name:"location"}),m(" "+h(l.value.address||"Position: "+l.value.latitude+", "+l.value.longitude),1)]),r("p",qe,[n(o(d),{name:"calendar"}),m(" "+h(ce(l.value.createdAt)),1)])])]),l.value.category?(g(),C("div",Ge,[n(o(Ee),{color:"primary"},{default:s(()=>[n(o(d),{name:ie(l.value.category)},null,8,["name"]),n(o(A),null,{default:s(()=>[m(h(ue(l.value.category)),1)]),_:1})]),_:1})])):v("",!0),l.value.description?(g(),C("div",je,[t[9]||(t[9]=r("h3",null,"Description",-1)),r("p",null,h(l.value.description),1)])):v("",!0),r("div",He,[l.value.type?(g(),C("div",We,[t[10]||(t[10]=r("h4",null,"Type",-1)),r("p",null,h(Z(l.value)),1)])):v("",!0)]),l.value.photos&&l.value.photos.length>0?(g(),C("div",Ye,[t[11]||(t[11]=r("h3",null,"Photos",-1)),r("div",Qe,[r("div",Je,[r("img",{src:l.value.photos[0],alt:"Photo principale",class:"report-photo"},null,8,Ke),l.value.photos.length>1?(g(),C("div",Xe," +"+h(l.value.photos.length-1),1)):v("",!0)])])])):v("",!0),r("div",et,[n(o(I),{expand:"block",fill:"outline",onClick:fe,class:"action-button"},{default:s(()=>[n(o(d),{name:"share",slot:"start"}),t[12]||(t[12]=m(" Partager ",-1))]),_:1}),n(o(I),{expand:"block",onClick:pe,class:"action-button"},{default:s(()=>[n(o(d),{name:"navigate",slot:"start"}),t[13]||(t[13]=m(" Itin√©raire ",-1))]),_:1})])])]),_:1})):v("",!0)]),_:1},8,["is-open"])]),_:1}))}},dt=De(tt,[["__scopeId","data-v-a0b93408"]]);export{dt as default};
