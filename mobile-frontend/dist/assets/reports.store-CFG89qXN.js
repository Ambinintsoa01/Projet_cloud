import{a3 as b,y as c,z as d,ai as i,ar as D,u as f}from"./index-vCZlUi6s.js";import{u as I}from"./useSignalements-Bl-XL2BA.js";const F=b("reports",()=>{const s=c([]),n=c({status:"all",category:"all",search:""}),u=c(!1),p=c(null),v=d(()=>{let r=[...s.value];if(n.value.status!=="all")if(n.value.status==="mine"){const e=f();r=r.filter(t=>{var o,l;return(t.userId||((o=t.user)==null?void 0:o.id)||t.createdBy)===((l=e.user)==null?void 0:l.id)})}else r=r.filter(e=>e.status===n.value.status);if(n.value.category!=="all"&&(r=r.filter(e=>{var a;return(((a=e.type)==null?void 0:a.libelle)||e.typeLabel||e.category)===n.value.category})),n.value.search){const e=n.value.search.toLowerCase();r=r.filter(t=>{var g;const a=t.title||((g=t.type)==null?void 0:g.libelle)||t.description||"",o=t.description||"",l=t.address||"";return a.toLowerCase().includes(e)||o.toLowerCase().includes(e)||l.toLowerCase().includes(e)})}return r}),y=d(()=>{const r=f();return s.value.filter(e=>{var t;return e.createdBy===((t=r.user)==null?void 0:t.id)})}),h=d(()=>{const r=s.value.length,e=s.value.filter(l=>l.status==="new").length,t=s.value.filter(l=>l.status==="in_progress").length,a=s.value.filter(l=>l.status==="completed").length,o=y.value.length;return{total:r,new:e,inProgress:t,completed:a,mine:o}});async function m(){u.value=!0;try{console.log("üîÑ fetchReports: D√©but...");const r=!!i.getAuthToken(),e=await D.getAllSignalements({preferFirebase:!r,syncOnOnline:!0});return console.log("üì• API getAllSignalements retourn√©:",{isArray:Array.isArray(e),length:Array.isArray(e)?e.length:"N/A",type:typeof e,sample:Array.isArray(e)&&e.length>0?e[0]:null}),s.value=Array.isArray(e)?e:[],i.setReportsData(s.value),console.log(`‚úÖ fetchReports: ${s.value.length} signalements stock√©s`),{success:!0}}catch(r){if(console.error("‚ùå fetchReports: Erreur lors du chargement des rapports:",r),typeof navigator<"u"?navigator.onLine:!0){console.log("üîÑ Tentative fallback Firestore...");try{const{getAllSignalements:a}=I(),o=await a();return console.log("üì• Firestore retourn√©:",{isArray:Array.isArray(o),length:Array.isArray(o)?o.length:"N/A"}),s.value=Array.isArray(o)?o:[],i.setReportsData(s.value),console.log(`‚úÖ ${s.value.length} signalements depuis Firestore`),{success:!0,fromFirebase:!0}}catch(a){console.error("‚ùå Erreur Firestore:",a)}}const t=i.getReportsData();if(s.value=Array.isArray(t)?t:[],s.value.length===0)throw r;return{success:!0,fromCache:!0}}finally{u.value=!1}}async function A(r){var e;u.value=!0;try{await new Promise(o=>setTimeout(o,3e3));const t=f(),a={id:`report_${Date.now()}_${Math.random().toString(36).substr(2,9)}`,...r,status:"new",createdBy:((e=t.user)==null?void 0:e.id)||"anonymous",createdAt:new Date().toISOString(),updatedAt:new Date().toISOString(),isAnonymous:r.isAnonymous||!1};return s.value.unshift(a),i.setReportsData(s.value),{success:!0,report:a}}catch(t){throw console.error("Erreur lors de la cr√©ation du rapport:",t),t}finally{u.value=!1}}async function w(r,e){u.value=!0;try{await new Promise(a=>setTimeout(a,1e3));const t=s.value.findIndex(a=>a.id===r);if(t===-1)throw new Error("Rapport non trouv√©");return s.value[t]={...s.value[t],...e,updatedAt:new Date().toISOString()},i.setReportsData(s.value),{success:!0,report:s.value[t]}}catch(t){throw console.error("Erreur lors de la mise √† jour du rapport:",t),t}finally{u.value=!1}}function R(r){n.value={...n.value,...r}}function S(r){p.value=r}return{reports:s,filters:n,isLoading:u,currentReport:p,filteredReports:v,myReports:y,reportsStats:h,fetchReports:m,createReport:A,updateReport:w,setFilters:R,setCurrentReport:S}});export{F as u};
