import{u as me,o as fe,G as pe,c as _,w as a,a as t,I as ge,b as ve,d as f,e as n,K as _e,L as H,M as he,l as p,V as be,q as z,i as d,p as E,n as Ie,a5 as we,f as ye,g as l,a6 as Ce,a7 as K,a8 as L,m,W as ke,X as k,D as w,P as Se,s as B,F as Re,B as Te,a9 as De,C as xe,aa as Ee,v as Le,ab as Q,ac as W,ad as Be,ae as Me,af as ze,ag as Pe,Y as Fe,Z as Ae,z as S,y as R,ah as Ne,t as $e}from"./index-vCZlUi6s.js";import{u as je}from"./reports.store-CFG89qXN.js";import{a as Ue}from"./constants-CKzTGXC9.js";import{_ as qe}from"./_plugin-vue_export-helper-DlAUqK2U.js";import"./useSignalements-Bl-XL2BA.js";const Ge={class:"stats-section"},Oe={class:"stat-icon"},He={class:"stat-content"},Ke={class:"stat-number"},Qe={class:"stat-icon stat-icon-danger"},We={class:"stat-content"},Xe={class:"stat-number"},Ye={class:"stat-icon stat-icon-warning"},Ze={class:"stat-content"},Je={class:"stat-number"},Ve={class:"stat-icon stat-icon-success"},es={class:"stat-content"},ss={class:"stat-number"},ts={class:"filters-section"},ns={class:"reports-section"},os={class:"section-header"},as={class:"results-count"},ls=["src","alt"],rs={key:1,class:"no-image"},is={class:"report-title-container"},cs={class:"report-type-emoji"},us={class:"report-title"},ds={class:"report-type-label"},ms={class:"report-address"},fs={class:"report-meta"},ps={class:"report-date"},gs={key:1,class:"empty-state"},vs={__name:"DashboardScreen",setup(_s){const P=ve(),T=me(),i=je(),g=R("all"),v=R(""),M=R(!1),h=R(1),X=R(20),b=s=>{if(!s)return"new";const e=s.toLowerCase();return e==="nouveau"||e==="new"?"new":e==="en_cours"||e==="in_progress"?"in_progress":e==="termine"||e==="terminÃ©"||e==="completed"?"completed":e},D=S(()=>{const s=i.reports;return{total:s.length,new:s.filter(e=>b(e.status)==="new").length,inProgress:s.filter(e=>b(e.status)==="in_progress").length,completed:s.filter(e=>b(e.status)==="completed").length}}),Y=S(()=>{var s,e;return((e=(s=T.user)==null?void 0:s.roles)==null?void 0:e.includes("MANAGER"))||!1}),y=S(()=>{var e,o;let s=[...i.reports];if(g.value!=="all")if(g.value==="mine"){const r=(e=T.user)==null?void 0:e.id,c=(o=T.user)==null?void 0:o.email;console.log('ðŸ” Filtre "Mes signalements":',{userId:r,userEmail:c,totalReports:s.length}),s=s.filter(u=>{var q,G,O;const x=u.userId||u.user_id||u.createdBy||u.created_by,j=u.userEmail||u.user_email||u.email,U=x===r||j===c||((q=u.user)==null?void 0:q.id)===r||((G=u.user)==null?void 0:G.email)===c;return U&&console.log("âœ… Signalement correspondant:",{id:u.id,reportUserId:x,reportUserEmail:j,description:(O=u.description)==null?void 0:O.substring(0,30)}),U}),console.log("ðŸ“Š RÃ©sultats filtrÃ©s:",s.length)}else s=s.filter(r=>b(r.status)===g.value);if(v.value.trim()){const r=v.value.toLowerCase();s=s.filter(c=>(c.title||c.description||"").toLowerCase().includes(r)||(c.description||"").toLowerCase().includes(r)||(c.address||"").toLowerCase().includes(r)||N(c.status).toLowerCase().includes(r))}return s}),F=S(()=>{const e=h.value*X.value;return y.value.slice(0,e)}),A=S(()=>F.value.length<y.value.length),C=s=>{g.value=s,i.setFilters({status:s})},Z=s=>{const e=s.detail.value;C(e)},J=s=>{v.value=s.detail.value||"",h.value=1},V=()=>{v.value="",h.value=1},ee=s=>({all:"",new:"nouveaux",in_progress:"en cours",completed:"terminÃ©s",mine:"personnels"})[s]||"",se=s=>{const e=b(s);return{new:"danger",in_progress:"warning",completed:"success"}[e]||"primary"},N=s=>{const e=b(s);return Ue[e]||s},te=s=>{const e=(s==null?void 0:s.type)||null,o=(e==null?void 0:e.id)||(s==null?void 0:s.typeId),r={1:"âš ï¸",2:"ðŸš—",3:"âœ“",4:"âš ï¸",5:"ðŸ”§",6:"ðŸ’§",7:"ðŸ"};if(o&&r[o])return r[o];const c=(e==null?void 0:e.libelle)||(e==null?void 0:e.label)||"";return{"ProblÃ¨me critique":"âš ï¸","Travaux en cours":"ðŸš—","ProblÃ¨me rÃ©solu":"âœ“","Infrastructure endommagÃ©e":"ðŸ”§","ProblÃ¨me d'inondation":"ðŸ’§","ChaussÃ©e dÃ©gradÃ©e":"ðŸ"}[c]||"ðŸ“"},ne=s=>{var r;const e=s==null?void 0:s.type;if(e!=null&&e.libelle)return e.libelle;const o=(s==null?void 0:s.typeId)||((r=s==null?void 0:s.type)==null?void 0:r.id);return o?`Type #${o}`:"Non dÃ©fini"},oe=(s,e)=>!s||s.length<=e?s:s.substring(0,e)+"...",ae=s=>{if(!s)return"Date inconnue";let e;if(typeof s=="object"){const u=(s==null?void 0:s.seconds)??(s==null?void 0:s._seconds),x=(s==null?void 0:s.nanoseconds)??(s==null?void 0:s._nanoseconds)??0;typeof u=="number"?e=new Date(u*1e3+Math.floor(x/1e6)):s!=null&&s.toDate&&typeof s.toDate=="function"?e=s.toDate():e=new Date(String(s))}else e=new Date(s);if(Number.isNaN(e.getTime()))return"Date inconnue";const r=Math.abs(new Date-e),c=Math.ceil(r/(1e3*60*60*24));return c===1?"Aujourd'hui":c===2?"Hier":c<=7?`Il y a ${c-1} jour${c-1>1?"s":""}`:e.toLocaleDateString("fr-FR",{day:"numeric",month:"short"})},le=s=>{i.setCurrentReport(s),P.push("/map")},re=async s=>{try{await i.updateReport(s.id,{status:"completed"}),await I("Signalement marquÃ© comme terminÃ©","success")}catch(e){console.error("Erreur lors de la mise Ã  jour:",e),await I("Erreur lors de la mise Ã  jour","danger")}},ie=async s=>{await(await Ne.create({header:"Confirmer la suppression",message:"ÃŠtes-vous sÃ»r de vouloir supprimer ce signalement ? Cette action est irrÃ©versible.",buttons:[{text:"Annuler",role:"cancel"},{text:"Supprimer",role:"destructive",handler:async()=>{try{const o=i.reports.findIndex(r=>r.id===s.id);o>-1&&i.reports.splice(o,1),await I("Signalement supprimÃ©","success")}catch(o){console.error("Erreur lors de la suppression:",o),await I("Erreur lors de la suppression","danger")}}}]})).present()},ce=s=>{setTimeout(()=>{h.value++,s.target.complete(),A.value||(s.target.disabled=!0)},1e3)},$=async s=>{M.value=!0;try{await i.fetchReports(),h.value=1,v.value="",await I("DonnÃ©es actualisÃ©es","success")}catch(e){console.error("Erreur lors du rafraÃ®chissement:",e),await I("Erreur lors du rafraÃ®chissement","danger")}finally{M.value=!1,s.detail.complete()}},ue=async()=>{await $({detail:{complete:()=>{}}})},de=()=>{P.push("/manager/problemes")},I=async(s,e="primary")=>{await(await $e.create({message:s,duration:2e3,color:e,position:"top"})).present()};return fe(async()=>{var s;console.log("ðŸ“± DashboardScreen mounted"),console.log("ðŸ‘¤ User actuel:",T.user),await i.fetchReports(),console.log("ðŸ“Š Signalements chargÃ©s:",i.reports.length),i.reports.length>0&&console.log("ðŸ“„ Ã‰chantillon de signalement:",{id:i.reports[0].id,userId:i.reports[0].userId,user_id:i.reports[0].user_id,createdBy:i.reports[0].createdBy,user:i.reports[0].user,description:(s=i.reports[0].description)==null?void 0:s.substring(0,30)})}),pe(()=>g.value,s=>{console.log("ðŸ”„ Filtre changÃ©:",s),h.value=1}),(s,e)=>(f(),_(t(ge),null,{default:a(()=>[n(t(_e),null,{default:a(()=>[n(t(H),null,{default:a(()=>[n(t(he),null,{default:a(()=>[...e[7]||(e[7]=[p("Tableau de bord",-1)])]),_:1}),n(t(be),{slot:"end"},{default:a(()=>[Y.value?(f(),_(t(z),{key:0,onClick:de,title:"GÃ©rer les problÃ¨mes"},{default:a(()=>[n(t(d),{name:"alert-circle"})]),_:1})):E("",!0),n(t(z),{onClick:ue},{default:a(()=>[n(t(d),{name:"refresh",class:Ie({rotating:M.value})},null,8,["class"])]),_:1})]),_:1})]),_:1}),n(t(H),{class:"search-toolbar"},{default:a(()=>[n(t(we),{modelValue:v.value,"onUpdate:modelValue":e[0]||(e[0]=o=>v.value=o),placeholder:"Rechercher des signalements...",onIonInput:J,class:"dashboard-search"},null,8,["modelValue"])]),_:1})]),_:1}),n(t(ye),{fullscreen:!0,class:"dashboard-content"},{default:a(()=>[l("div",Ge,[n(t(Ce),{class:"stats-grid"},{default:a(()=>[n(t(K),null,{default:a(()=>[n(t(L),{size:"6"},{default:a(()=>[l("div",{class:"stat-card",onClick:e[1]||(e[1]=o=>C("all"))},[l("div",Oe,[n(t(d),{name:"document",color:"primary"})]),l("div",He,[l("div",Ke,m(D.value.total),1),e[8]||(e[8]=l("div",{class:"stat-label"},"Total",-1))])])]),_:1}),n(t(L),{size:"6"},{default:a(()=>[l("div",{class:"stat-card",onClick:e[2]||(e[2]=o=>C("new"))},[l("div",Qe,[n(t(d),{name:"alert-circle"})]),l("div",We,[l("div",Xe,m(D.value.new),1),e[9]||(e[9]=l("div",{class:"stat-label"},"Nouveaux",-1))])])]),_:1})]),_:1}),n(t(K),null,{default:a(()=>[n(t(L),{size:"6"},{default:a(()=>[l("div",{class:"stat-card",onClick:e[3]||(e[3]=o=>C("in_progress"))},[l("div",Ye,[n(t(d),{name:"construct"})]),l("div",Ze,[l("div",Je,m(D.value.inProgress),1),e[10]||(e[10]=l("div",{class:"stat-label"},"En cours",-1))])])]),_:1}),n(t(L),{size:"6"},{default:a(()=>[l("div",{class:"stat-card",onClick:e[4]||(e[4]=o=>C("completed"))},[l("div",Ve,[n(t(d),{name:"checkmark-circle"})]),l("div",es,[l("div",ss,m(D.value.completed),1),e[11]||(e[11]=l("div",{class:"stat-label"},"TerminÃ©s",-1))])])]),_:1})]),_:1})]),_:1})]),l("div",ts,[n(t(ke),{modelValue:g.value,"onUpdate:modelValue":e[5]||(e[5]=o=>g.value=o),onIonChange:Z,scrollable:"",class:"filters-segment"},{default:a(()=>[n(t(k),{value:"all"},{default:a(()=>[n(t(w),null,{default:a(()=>[...e[12]||(e[12]=[p("Tous",-1)])]),_:1})]),_:1}),n(t(k),{value:"new"},{default:a(()=>[n(t(w),null,{default:a(()=>[...e[13]||(e[13]=[p("Nouveaux",-1)])]),_:1})]),_:1}),n(t(k),{value:"in_progress"},{default:a(()=>[n(t(w),null,{default:a(()=>[...e[14]||(e[14]=[p("En cours",-1)])]),_:1})]),_:1}),n(t(k),{value:"completed"},{default:a(()=>[n(t(w),null,{default:a(()=>[...e[15]||(e[15]=[p("TerminÃ©s",-1)])]),_:1})]),_:1}),n(t(k),{value:"mine"},{default:a(()=>[n(t(w),null,{default:a(()=>[...e[16]||(e[16]=[p("Mes signalements",-1)])]),_:1})]),_:1})]),_:1},8,["modelValue"])]),l("div",ns,[l("div",os,[l("h3",null,"Signalements "+m(ee(g.value)),1),l("span",as,m(y.value.length)+" rÃ©sultat"+m(y.value.length>1?"s":""),1)]),y.value.length>0?(f(),_(t(Se),{key:0,class:"reports-list"},{default:a(()=>[(f(!0),B(Re,null,Te(F.value,o=>(f(),_(t(De),{key:o.id},{default:a(()=>[n(t(xe),{class:"report-item",onClick:r=>le(o),button:""},{default:a(()=>[n(t(Ee),{slot:"start",class:"report-thumbnail"},{default:a(()=>[o.photos&&o.photos.length>0?(f(),B("img",{key:0,src:o.photos[0],alt:"Photo de "+o.title,class:"report-image"},null,8,ls)):(f(),B("div",rs,[n(t(d),{name:"image",color:"medium"})]))]),_:2},1024),n(t(w),{class:"report-label"},{default:a(()=>[l("div",is,[l("span",cs,m(te(o)),1),l("h2",us,m(o.description||o.title||"Sans description"),1)]),l("p",ds,m(ne(o)),1),l("p",ms,[n(t(d),{name:"location",size:"small"}),p(" "+m(oe(o.address,40)),1)]),l("p",fs,[n(t(Le),{color:se(o.status),size:"small"},{default:a(()=>[p(m(N(o.status)),1)]),_:2},1032,["color"]),l("span",ps,m(ae(o.dateCreation||o.createdAt)),1)])]),_:2},1024),n(t(d),{name:"chevron-forward",slot:"end",color:"medium",class:"item-chevron"})]),_:2},1032,["onClick"]),n(t(Q),{side:"end"},{default:a(()=>[n(t(W),{color:"danger",onClick:r=>ie(o),expandable:""},{default:a(()=>[n(t(d),{name:"trash",slot:"icon-only"})]),_:1},8,["onClick"])]),_:2},1024),n(t(Q),{side:"start"},{default:a(()=>[o.status!=="completed"?(f(),_(t(W),{key:0,color:"success",onClick:r=>re(o),expandable:""},{default:a(()=>[n(t(d),{name:"checkmark",slot:"icon-only"}),e[17]||(e[17]=p(" TerminÃ© ",-1))]),_:1},8,["onClick"])):E("",!0)]),_:2},1024)]),_:2},1024))),128))]),_:1})):(f(),B("div",gs,[n(t(d),{name:"document-outline",size:"large",color:"medium"}),e[19]||(e[19]=l("h3",null,"Aucun signalement trouvÃ©",-1)),e[20]||(e[20]=l("p",null,"Il n'y a pas de signalements correspondant Ã  votre recherche.",-1)),v.value?(f(),_(t(z),{key:0,fill:"clear",onClick:V,class:"clear-search-button"},{default:a(()=>[...e[18]||(e[18]=[p(" Effacer la recherche ",-1)])]),_:1})):E("",!0)])),A.value?(f(),_(t(Be),{key:2,onIonInfinite:ce,threshold:"100px"},{default:a(()=>[n(t(Me),{"loading-spinner":"crescent","loading-text":"Chargement..."})]),_:1})):E("",!0)]),n(t(ze),{slot:"fixed",onIonRefresh:e[6]||(e[6]=o=>$(o))},{default:a(()=>[n(t(Pe),{"pulling-icon":"chevron-down","pulling-text":"Tirer pour actualiser","refreshing-spinner":"crescent","refreshing-text":"Actualisation..."})]),_:1})]),_:1}),n(t(Fe),{vertical:"bottom",horizontal:"end",slot:"fixed"},{default:a(()=>[n(t(Ae),{"router-link":"/report/new"},{default:a(()=>[n(t(d),{name:"add"})]),_:1})]),_:1})]),_:1}))}},Cs=qe(vs,[["__scopeId","data-v-13a1f318"]]);export{Cs as default};
