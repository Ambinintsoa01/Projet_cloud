import{o as X,c as m,w as n,a as t,I as Y,y as v,t as Z,d as i,e as l,K as B,L as S,V as A,as as ee,M as F,g as o,f as L,s as f,r as R,i as g,F as O,B as z,m as u,p as _,q as k,l as d,af as te,ag as se,_ as le,C,D as w,a1 as ae,a2 as oe,k as D,a0 as ne,j as N,z as re,x as ie}from"./index-vCZlUi6s.js";import{u as ue}from"./useSignalements-Bl-XL2BA.js";import{u as de}from"./useProblemes-BKKAK_Nt.js";import{_ as ce}from"./_plugin-vue_export-helper-DlAUqK2U.js";const pe={key:0,class:"loading-container"},me={key:1,class:"empty-state"},ve={key:2,class:"problemes-list"},fe={class:"card-header"},ge={class:"user-info"},ye={class:"avatar"},be={class:"user-details"},Ie={class:"date"},_e={class:"card-body"},ke={class:"location-section"},Ce={class:"description-section"},we={class:"description-text"},he={key:0,class:"type-section"},Ve={class:"type-name"},Me={class:"card-footer"},xe={class:"summary-section"},De={class:"location-text"},Te={class:"form-section"},Ee={class:"button-group"},Pe={__name:"ManagerProblemesScreen",setup(Be){const{signalementTypes:T,loadSignalementTypes:U}=ue(),{listOpenProblemes:j,convertProbleme:$}=de(),b=v([]),h=v(!1),y=v(!1),V=v(!1),p=v(null),r=v({typeId:null,description:"",surfaceM2:null,budget:null}),c=v({}),q=re(()=>{var s;return r.value.typeId&&((s=r.value.description)==null?void 0:s.trim().length)>=10&&Object.keys(c.value).length===0}),M=async()=>{h.value=!0;try{const s=await j();b.value=s||[],console.log("✅ Problèmes ouverts chargés depuis Firestore:",b.value.length)}catch(s){console.error("Erreur lors du chargement des problèmes:",s),await x("Erreur lors du chargement des problèmes","danger")}finally{h.value=!1}},H=s=>s?s.substring(0,2).toUpperCase():"?",K=s=>{var a;return s?(s instanceof Date?s:((a=s==null?void 0:s.toDate)==null?void 0:a.call(s))||new Date(s)).toLocaleDateString("fr-FR",{day:"numeric",month:"short",hour:"2-digit",minute:"2-digit"}):"Date inconnue"},G=s=>{if(!s)return"Non spécifié";const e=T.value.find(a=>a.id===s);return(e==null?void 0:e.libelle)||s},J=s=>{p.value=s,r.value={typeId:s.typeId||null,description:s.description,surfaceM2:null,budget:null},c.value={},V.value=!0},I=()=>{V.value=!1,p.value=null,r.value={typeId:null,description:"",surfaceM2:null,budget:null},c.value={}},E=s=>{const e={};s==="typeId"&&(r.value.typeId||(e.typeId="Veuillez sélectionner un type")),s==="description"&&((!r.value.description||r.value.description.trim().length<10)&&(e.description="La description doit contenir au moins 10 caractères"),r.value.description&&r.value.description.length>500&&(e.description="La description ne doit pas dépasser 500 caractères")),c.value={...c.value,...e},e[s]===void 0&&delete c.value[s]},Q=async()=>{if(!p.value)return;y.value=!0;const s=await ie.create({message:"Conversion en cours...",spinner:"crescent"});try{await s.present();const e=await $(p.value.id,{typeId:r.value.typeId,description:r.value.description,surfaceM2:r.value.surfaceM2||null,budget:r.value.budget||null});(e!=null&&e.success||e!=null&&e.id)&&(await x("Problème converti en signalement avec succès !","success"),I(),await M())}catch(e){console.error("Erreur lors de la conversion:",e),await x(e.message||"Erreur lors de la conversion","danger")}finally{y.value=!1,await s.dismiss()}},W=async s=>{await M(),await s.detail.complete()},x=async(s,e="primary")=>{await(await Z.create({message:s,duration:3e3,color:e,position:"top"})).present()};return X(async()=>{try{await U()}catch(s){console.error("Erreur au chargement des types:",s)}await M()}),(s,e)=>(i(),m(t(Y),null,{default:n(()=>[l(t(B),null,{default:n(()=>[l(t(S),null,{default:n(()=>[l(t(A),{slot:"start"},{default:n(()=>[l(t(ee),{"default-href":"/dashboard"})]),_:1}),l(t(F),null,{default:n(()=>[...e[6]||(e[6]=[o("span",{class:"app-logo"},"ROAD ALERT",-1),o("span",{class:"title-sep"},"•",-1),o("span",{class:"app-title"},"Problèmes à traiter",-1)])]),_:1})]),_:1})]),_:1}),l(t(L),{class:"problemes-content"},{default:n(()=>[h.value?(i(),f("div",pe,[l(t(R),{name:"crescent",color:"primary"}),e[7]||(e[7]=o("p",null,"Chargement des problèmes...",-1))])):b.value.length===0?(i(),f("div",me,[l(t(g),{name:"checkmark-circle-outline",size:"large"}),e[8]||(e[8]=o("h2",null,"Aucun problème en attente",-1)),e[9]||(e[9]=o("p",null,"Tous les problèmes signalés ont été traités ✓",-1))])):(i(),f("div",ve,[(i(!0),f(O,null,z(b.value,a=>{var P;return i(),f("div",{key:a.id,class:"probleme-card"},[o("div",fe,[o("div",ge,[o("div",ye,u(H(a.userId)),1),o("div",be,[o("h3",null,"Utilisateur #"+u(((P=a.userId)==null?void 0:P.substring(0,8))||"Anonyme"),1),o("p",Ie,u(K(a.createdAt)),1)])]),e[10]||(e[10]=o("div",{class:"status-badge"},[o("span",{class:"badge-open"},"Ouvert")],-1))]),o("div",_e,[o("div",ke,[l(t(g),{name:"location-outline",size:"small"}),o("span",null,u(a.latitude.toFixed(4))+", "+u(a.longitude.toFixed(4)),1)]),o("div",Ce,[e[11]||(e[11]=o("p",{class:"label"},"Problème signalé:",-1)),o("p",we,u(a.description),1)]),a.typeId?(i(),f("div",he,[e[12]||(e[12]=o("p",{class:"label"},"Type suggéré:",-1)),o("p",Ve,u(G(a.typeId)),1)])):_("",!0)]),o("div",Me,[l(t(k),{fill:"solid",size:"small",onClick:Se=>J(a),class:"convert-button"},{default:n(()=>[l(t(g),{name:"checkmark-circle",slot:"start"}),e[13]||(e[13]=d(" Convertir en signalement ",-1))]),_:1},8,["onClick"])])])}),128))])),l(t(te),{slot:"fixed",onIonRefresh:W},{default:n(()=>[l(t(se))]),_:1})]),_:1}),l(t(le),{"is-open":V.value,onDidDismiss:I,"initial-break-point":.75,"break-points":[0,.75,1],class:"convert-modal"},{default:n(()=>[l(t(B),null,{default:n(()=>[l(t(S),null,{default:n(()=>[l(t(F),null,{default:n(()=>[...e[14]||(e[14]=[o("span",{class:"app-logo"},"ROAD ALERT",-1),o("span",{class:"title-sep"},"•",-1),o("span",{class:"app-title"},"Convertir le problème",-1)])]),_:1}),l(t(A),{slot:"end"},{default:n(()=>[l(t(k),{onClick:I},{default:n(()=>[l(t(g),{name:"close"})]),_:1})]),_:1})]),_:1})]),_:1}),p.value?(i(),m(t(L),{key:0,class:"modal-content"},{default:n(()=>[o("div",xe,[o("h3",null,u(p.value.description),1),o("p",De,[l(t(g),{name:"location",size:"small"}),d(" "+u(p.value.latitude.toFixed(4))+", "+u(p.value.longitude.toFixed(4)),1)])]),o("div",Te,[l(t(C),{class:"form-item"},{default:n(()=>[l(t(w),{position:"floating"},{default:n(()=>[...e[15]||(e[15]=[d("Type de signalement *",-1)])]),_:1}),l(t(ae),{modelValue:r.value.typeId,"onUpdate:modelValue":e[0]||(e[0]=a=>r.value.typeId=a),placeholder:"Sélectionner un type",onIonChange:e[1]||(e[1]=a=>E("typeId"))},{default:n(()=>[(i(!0),f(O,null,z(t(T),a=>(i(),m(t(oe),{key:a.id,value:a.id},{default:n(()=>[d(u(a.libelle),1)]),_:2},1032,["value"]))),128))]),_:1},8,["modelValue"])]),_:1}),c.value.typeId?(i(),m(t(D),{key:0,class:"error-note"},{default:n(()=>[d(u(c.value.typeId),1)]),_:1})):_("",!0),l(t(C),{class:"form-item"},{default:n(()=>[l(t(w),{position:"floating"},{default:n(()=>[...e[16]||(e[16]=[d("Description complète *",-1)])]),_:1}),l(t(ne),{modelValue:r.value.description,"onUpdate:modelValue":e[2]||(e[2]=a=>r.value.description=a),placeholder:"Entrez une description détaillée",rows:"3",onIonBlur:e[3]||(e[3]=a=>E("description"))},null,8,["modelValue"])]),_:1}),c.value.description?(i(),m(t(D),{key:1,class:"error-note"},{default:n(()=>[d(u(c.value.description),1)]),_:1})):_("",!0),l(t(D),{class:"char-count"},{default:n(()=>{var a;return[d(u(((a=r.value.description)==null?void 0:a.length)||0)+"/500 ",1)]}),_:1}),l(t(C),{class:"form-item"},{default:n(()=>[l(t(w),{position:"floating"},{default:n(()=>[...e[17]||(e[17]=[d("Surface (m²)",-1)])]),_:1}),l(t(N),{modelValue:r.value.surfaceM2,"onUpdate:modelValue":e[4]||(e[4]=a=>r.value.surfaceM2=a),modelModifiers:{number:!0},type:"number",placeholder:"Ex: 150",min:"0",step:"0.01"},null,8,["modelValue"])]),_:1}),l(t(C),{class:"form-item"},{default:n(()=>[l(t(w),{position:"floating"},{default:n(()=>[...e[18]||(e[18]=[d("Budget estimé (Ariary)",-1)])]),_:1}),l(t(N),{modelValue:r.value.budget,"onUpdate:modelValue":e[5]||(e[5]=a=>r.value.budget=a),modelModifiers:{number:!0},type:"number",placeholder:"Ex: 50000",min:"0",step:"1000"},null,8,["modelValue"])]),_:1})]),o("div",Ee,[l(t(k),{fill:"clear",onClick:I,disabled:y.value},{default:n(()=>[...e[19]||(e[19]=[d(" Annuler ",-1)])]),_:1},8,["disabled"]),l(t(k),{fill:"solid",color:"success",onClick:Q,disabled:!q.value||y.value,class:"submit-button"},{default:n(()=>[y.value?(i(),m(t(R),{key:0,slot:"start",name:"crescent"})):(i(),m(t(g),{key:1,name:"checkmark-circle",slot:"start"})),e[20]||(e[20]=d(" Convertir ",-1))]),_:1},8,["disabled"])])]),_:1})):_("",!0)]),_:1},8,["is-open"])]),_:1}))}},Oe=ce(Pe,[["__scopeId","data-v-e67bbda8"]]);export{Oe as default};
