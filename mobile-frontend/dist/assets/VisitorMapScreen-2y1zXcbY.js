import{o as J,G as K,H as X,c as w,w as c,a as n,I as Y,y,t as V,J as tt,d as h,e as a,K as st,L as P,M as et,g as e,f as ot,N as x,q as L,i as d,s as S,r as rt,p as nt,O as T,m as u,P as at,F as it,B as ct,C as lt,D as ut,A as dt,l as pt,Q as ft,n as z,R as mt,S as vt,T as bt,U as ht}from"./index-vCZlUi6s.js";import{L as p}from"./leaflet-src-C8Aqtbpj.js";import"./leaflet.markercluster-src-NIqeFdU9.js";import{u as yt}from"./reports.store-CFG89qXN.js";import{_ as _t}from"./_plugin-vue_export-helper-DlAUqK2U.js";import"./useSignalements-Bl-XL2BA.js";const kt={class:"map-section"},gt={class:"map-controls"},It={class:"refresh-button-container"},Ct={key:0,class:"loading-overlay"},At={class:"table-section"},wt={class:"table-header"},xt={key:0,class:"empty-state"},Lt={class:"item-header"},St={class:"item-type"},Tt={class:"type-emoji"},zt={class:"type-label"},Dt={class:"item-description"},Et={class:"item-date"},$t={class:"stats-section"},Bt={class:"stats-grid"},Nt={class:"stat-card"},Ot={class:"stat-number"},Mt={class:"stat-card"},jt={class:"stat-number"},Pt={class:"stat-card"},Rt={class:"stat-number"},Zt={class:"stat-card"},Ut={class:"stat-number"},qt={class:"nav-buttons"},Ft={__name:"VisitorMapScreen",setup(Wt){const _=y(null);let i=null,v=null,b=null;const f=y([]),D=y(!0),l=y("map"),R=t=>t?{"!":"‚ö†Ô∏è",car:"üöó",check:"‚úì",wrench:"üîß",water:"üíß",checkered:"üèÅ"}[t]||t:null,E=t=>{if(t==null)return null;if(typeof t=="number")return t;const s=Number(t);return Number.isFinite(s)?s:null},k=(t,s=null)=>{const o=(t==null?void 0:t.type)||null,r=typeof o=="string"?o:((o==null?void 0:o.libelle)||(o==null?void 0:o.label)||(o==null?void 0:o.name)||"").toString(),m=E((o==null?void 0:o.id)||(o==null?void 0:o.typeId)||(t==null?void 0:t.typeId)||(t==null?void 0:t.type_id)||(t==null?void 0:t.type)||s),C={"Probl√®me critique":"‚ö†Ô∏è","Travaux en cours":"üöó","Probl√®me r√©solu":"‚úì","Alerte signal√©e":"‚ö†Ô∏è","Infrastructure endommag√©e":"üîß","Probl√®me d'inondation":"üíß","Chauss√©e d√©grad√©e":"üèÅ"},A={1:"‚ö†Ô∏è",2:"üöó",3:"‚úì",4:"‚ö†Ô∏è",5:"üîß",6:"üíß",7:"üèÅ"};return r&&C[r]?C[r]:m&&A[m]?A[m]:R((o==null?void 0:o.icon_symbol)||(o==null?void 0:o.iconSymbol))||"‚ö†Ô∏è"},Z=t=>t?typeof t=="string"&&t.startsWith("#")?t:{red:"#dc3545",purple:"#6f42c1",green:"#28a745",yellow:"#ffc107",orange:"#fd7e14",blue:"#007bff","red-white":"#dc3545"}[t]||"#6c757d":"#6c757d",U=t=>({1:"#dc3545",2:"#6f42c1",3:"#28a745",4:"#ffc107",5:"#fd7e14",6:"#007bff",7:"#dc3545",8:"#666666",9:"#DD0000",10:"#999999"})[t]||"#6c757d",q=t=>{const s=(t==null?void 0:t.type)||null,o=E((s==null?void 0:s.id)||(s==null?void 0:s.typeId)||(t==null?void 0:t.typeId)||(t==null?void 0:t.type_id)||(t==null?void 0:t.type));if(!s&&!o)return{html:`<div style="
        width: 40px;
        height: 40px;
        background-color: #6c757d;
        border: 3px solid white;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        box-shadow: 0 3px 6px rgba(0,0,0,0.4);
        font-size: 18px;
      ">‚ö†Ô∏è</div>`,className:"custom-marker",iconSize:[40,40],iconAnchor:[20,20],popupAnchor:[0,-20]};const r=Z((s==null?void 0:s.icon_color)||(s==null?void 0:s.iconColor))||U(o),m=k(t,o);return{html:`<div style="
      width: 40px;
      height: 40px;
      ${((s==null?void 0:s.icon_symbol)||(s==null?void 0:s.iconSymbol))==="checkered"?`background: repeating-linear-gradient(
        45deg,
        ${r},
        ${r} 5px,
        white 5px,
        white 10px
      );`:`background-color: ${r};`}
      border: 3px solid white;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      box-shadow: 0 3px 6px rgba(0,0,0,0.4);
      font-size: 18px;
    ">${m}</div>`,className:"custom-marker",iconSize:[40,40],iconAnchor:[20,20],popupAnchor:[0,-20]}},$=t=>{var r;const s=t==null?void 0:t.type;if(s!=null&&s.libelle)return s.libelle;const o=(t==null?void 0:t.typeId)||((r=t==null?void 0:t.type)==null?void 0:r.id);return o?`Type #${o}`:"‚Äî"},B=t=>{switch((t||"").toLowerCase()){case"nouveau":return"#48bb78";case"en_cours":return"#ed8936";case"termine":case"termin√©":return"#3182ce";default:return"#718096"}},N=t=>{switch((t||"").toLowerCase()){case"nouveau":return"Nouveau";case"en_cours":return"En cours";case"termine":case"termin√©":return"Termin√©";case"en_attente":return"En attente";default:return t||"Inconnu"}},O=t=>{if(!t)return"Date inconnue";let s;if(typeof t=="object"){const o=(t==null?void 0:t.seconds)??(t==null?void 0:t._seconds),r=(t==null?void 0:t.nanoseconds)??(t==null?void 0:t._nanoseconds)??0;typeof o=="number"?s=new Date(o*1e3+Math.floor(r/1e6)):t!=null&&t.toDate&&typeof t.toDate=="function"?s=t.toDate():s=new Date(String(t))}else s=new Date(t);return Number.isNaN(s.getTime())?"Date inconnue":s.toLocaleDateString("fr-FR",{day:"numeric",month:"short",year:"numeric"})},g=t=>{const s={nouveau:o=>(o.status||"").toLowerCase()==="nouveau",en_cours:o=>(o.status||"").toLowerCase()==="en_cours",termine:o=>(o.status||"").toLowerCase()==="termine"||(o.status||"").toLowerCase()==="termin√©"};return s[t]?f.value.filter(s[t]).length:0},F=async()=>{if(_.value)try{delete p.Icon.Default.prototype._getIconUrl,p.Icon.Default.mergeOptions({iconRetinaUrl:"https://unpkg.com/leaflet@1.9.4/dist/images/marker-icon-2x.png",iconUrl:"https://unpkg.com/leaflet@1.9.4/dist/images/marker-icon.png",shadowUrl:"https://unpkg.com/leaflet@1.9.4/dist/images/marker-shadow.png"}),i=p.map(_.value,{center:[-18.8792,47.5079],zoom:12,zoomControl:!1,attributionControl:!0,scrollWheelZoom:!0,dragging:!0,touchZoom:!0,doubleClickZoom:!1,updateWhenIdle:!0,preferCanvas:!0,fadeAnimation:!1,zoomAnimation:!0}),p.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png",{maxZoom:18,maxNativeZoom:18,attribution:"&copy; OpenStreetMap contributors",subdomains:["a","b","c"],errorTileUrl:"data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7",keepBuffer:2,updateInterval:200,updateWhenIdle:!0,updateWhenZooming:!0,reuseTiles:!0,noWrap:!0,crossOrigin:"anonymous"}).addTo(i);try{b=p.markerClusterGroup({chunkedLoading:!0,spiderfyOnMaxZoom:!0,showCoverageOnHover:!1,zoomToBoundsOnClick:!0,removeOutsideVisibleBounds:!0,animate:!1,maxClusterRadius:60,disableClusteringAtZoom:17,iconCreateFunction:t=>{const s=t.getChildCount();let o="small",r=25;return s>20?(o="large",r=35):s>10&&(o="medium",r=30),p.divIcon({html:`<div class="cluster cluster-${o}"><span>${s}</span></div>`,className:"cluster-icon",iconSize:[r*2,r*2],iconAnchor:[r,r]})}}),i.addLayer(b)}catch(t){console.error("Erreur cluster:",t),b=null}await M()}catch(t){console.error("Erreur initialisation carte:",t),await I("Erreur lors de l'initialisation de la carte","danger")}finally{D.value=!1}},M=async()=>{try{const t=yt();await t.fetchReports(),f.value=t.reports,W()}catch(t){console.error("Erreur chargement signalements:",t),await I("Erreur lors du chargement des signalements","danger")}},W=()=>{if(i)try{if(b){b.clearLayers();let t=0;f.value.forEach(s=>{const o=j(s);o&&(b.addLayer(o),t++)})}else v&&i.removeLayer(v),v=p.featureGroup(),f.value.forEach(t=>{const s=j(t);s&&v.addLayer(s)}),v.getLayers().length>0&&i.addLayer(v)}catch(t){console.error("Erreur mise √† jour marqueurs:",t)}},j=t=>{try{if(!t.latitude||!t.longitude)return null;const s=q(t),o=p.divIcon(s),r=p.marker([t.latitude,t.longitude],{icon:o}),m=`
      <div class="marker-popup">
        <h4>${t.description||"Sans description"}</h4>
        <p class="address">üìç ${t.address||"Position"}</p>
        <div class="status">
          <span class="badge" style="background-color: ${B(t.status)}">
            ${N(t.status)}
          </span>
        </div>
        <p class="type"><strong>Type:</strong> ${k(t)} ${$(t)}</p>
        <p class="date"><strong>Date:</strong> ${O(t.dateCreation||t.createdAt)}</p>
      </div>
    `;return r.bindPopup(m),r}catch(s){return console.error("Erreur cr√©ation marqueur:",s),null}},G=()=>{i&&i.zoomIn()},H=()=>{i&&i.zoomOut()},Q=async()=>{await M(),await I("Donn√©es actualis√©es","success")},I=async(t,s="primary")=>{await(await V.create({message:t,duration:3e3,color:s,position:"top"})).present()};return J(async()=>{await F(),i&&setTimeout(()=>i.invalidateSize(),200)}),K(l,t=>{t==="map"&&i&&setTimeout(()=>i.invalidateSize(),200)}),X(()=>{i&&(i.remove(),i=null)}),(t,s)=>{const o=tt("router-link");return h(),w(n(Y),null,{default:c(()=>[a(n(st),null,{default:c(()=>[a(n(P),{class:"visitor-toolbar"},{default:c(()=>[a(n(et),null,{default:c(()=>[...s[3]||(s[3]=[e("span",{class:"app-logo"},"ROAD ALERT",-1)])]),_:1})]),_:1})]),_:1}),a(n(ot),{fullscreen:!0,class:"visitor-map-content"},{default:c(()=>[x(e("div",kt,[e("div",{ref_key:"mapContainer",ref:_,class:"map-container"},null,512),e("div",gt,[a(n(L),{fill:"solid",shape:"round",onClick:G,class:"control-button"},{default:c(()=>[a(n(d),{name:"add"})]),_:1}),a(n(L),{fill:"solid",shape:"round",onClick:H,class:"control-button"},{default:c(()=>[a(n(d),{name:"remove"})]),_:1})]),e("div",It,[a(n(L),{fill:"solid",shape:"round",onClick:Q,class:"refresh-button"},{default:c(()=>[a(n(d),{name:"refresh"})]),_:1})]),D.value?(h(),S("div",Ct,[a(n(rt),{name:"crescent",color:"primary"}),s[4]||(s[4]=e("p",null,"Chargement de la carte...",-1))])):nt("",!0)],512),[[T,l.value==="map"]]),x(e("div",At,[e("div",wt,[e("h3",null,u(f.value.length)+" signalement(s)",1)]),f.value.length===0?(h(),S("div",xt,[a(n(d),{name:"document-outline",size:"large",color:"medium"}),s[5]||(s[5]=e("p",null,"Aucun signalement",-1))])):(h(),w(n(at),{key:1,class:"signalements-list"},{default:c(()=>[(h(!0),S(it,null,ct(f.value,r=>(h(),w(n(lt),{key:r.id||r.firebaseId,class:"signalement-item"},{default:c(()=>[a(n(ut),{class:"item-content"},{default:c(()=>[e("div",Lt,[e("div",St,[e("span",Tt,u(k(r)),1),e("span",zt,u($(r)),1)]),e("span",{class:"item-status",style:dt({backgroundColor:B(r.status)})},u(N(r.status)),5)]),e("p",Dt,u(r.description||"Aucune description"),1),e("p",Et,[a(n(d),{name:"calendar-outline"}),pt(" "+u(O(r.dateCreation||r.createdAt)),1)])]),_:2},1024)]),_:2},1024))),128))]),_:1}))],512),[[T,l.value==="table"]]),x(e("div",$t,[s[14]||(s[14]=e("div",{class:"stats-header"},[e("h3",null,"Statistiques")],-1)),e("div",Bt,[e("div",Nt,[e("div",Ot,u(f.value.length),1),s[6]||(s[6]=e("div",{class:"stat-label"},"Total",-1)),s[7]||(s[7]=e("div",{class:"stat-icon"},"üìç",-1))]),e("div",Mt,[e("div",jt,u(g("nouveau")),1),s[8]||(s[8]=e("div",{class:"stat-label"},"Nouveaux",-1)),s[9]||(s[9]=e("div",{class:"stat-icon"},"üî¥",-1))]),e("div",Pt,[e("div",Rt,u(g("en_cours")),1),s[10]||(s[10]=e("div",{class:"stat-label"},"En cours",-1)),s[11]||(s[11]=e("div",{class:"stat-icon"},"üü°",-1))]),e("div",Zt,[e("div",Ut,u(g("termine")),1),s[12]||(s[12]=e("div",{class:"stat-label"},"Termin√©s",-1)),s[13]||(s[13]=e("div",{class:"stat-icon"},"üü¢",-1))])]),s[15]||(s[15]=e("div",{class:"legend-section"},[e("h4",null,"L√©gende des types"),e("div",{class:"legend-items"},[e("div",{class:"legend-item"},[e("span",{class:"legend-emoji"},"‚ö†Ô∏è"),e("span",{class:"legend-text"},"Probl√®me critique")]),e("div",{class:"legend-item"},[e("span",{class:"legend-emoji"},"üöó"),e("span",{class:"legend-text"},"Travaux en cours")]),e("div",{class:"legend-item"},[e("span",{class:"legend-emoji"},"‚úì"),e("span",{class:"legend-text"},"Probl√®me r√©solu")]),e("div",{class:"legend-item"},[e("span",{class:"legend-emoji"},"üîß"),e("span",{class:"legend-text"},"Infrastructure endommag√©e")]),e("div",{class:"legend-item"},[e("span",{class:"legend-emoji"},"üíß"),e("span",{class:"legend-text"},"Probl√®me d'inondation")]),e("div",{class:"legend-item"},[e("span",{class:"legend-emoji"},"üèÅ"),e("span",{class:"legend-text"},"Chauss√©e d√©grad√©e")])])],-1))],512),[[T,l.value==="stats"]])]),_:1}),a(n(ft),{class:"visitor-nav-footer"},{default:c(()=>[a(n(P),{class:"visitor-nav-bar"},{default:c(()=>[e("div",qt,[e("div",{class:z([{active:l.value==="map"},"nav-btn"]),onClick:s[0]||(s[0]=r=>l.value="map")},[a(n(d),{icon:n(mt),class:"nav-icon"},null,8,["icon"])],2),e("div",{class:z([{active:l.value==="table"},"nav-btn"]),onClick:s[1]||(s[1]=r=>l.value="table")},[a(n(d),{icon:n(vt),class:"nav-icon"},null,8,["icon"])],2),e("div",{class:z([{active:l.value==="stats"},"nav-btn"]),onClick:s[2]||(s[2]=r=>l.value="stats")},[a(n(d),{icon:n(bt),class:"nav-icon"},null,8,["icon"])],2),a(o,{to:"/login",class:"nav-btn login-btn nav-link"},{default:c(()=>[a(n(d),{icon:n(ht),class:"nav-icon"},null,8,["icon"])]),_:1})])]),_:1})]),_:1})]),_:1})}}},Yt=_t(Ft,[["__scopeId","data-v-e789c922"]]);export{Yt as default};
