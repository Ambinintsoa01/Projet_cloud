import{aE as d,az as c,au as u,aB as h,aC as y,ax as g,aw as w,aF as L,aA as U,y as f,aG as z,aH as N,at as C}from"./index-vCZlUi6s.js";const v=[{id:"1",libelle:"Probl√®me critique",icon_color:"red",icon_symbol:"!"},{id:"2",libelle:"Travaux en cours",icon_color:"purple",icon_symbol:"car"},{id:"3",libelle:"Probl√®me r√©solu",icon_color:"green",icon_symbol:"check"},{id:"4",libelle:"Alerte signal√©e",icon_color:"yellow",icon_symbol:"!"},{id:"5",libelle:"Infrastructure endommag√©e",icon_color:"orange",icon_symbol:"wrench"},{id:"6",libelle:"Probl√®me d'inondation",icon_color:"blue",icon_symbol:"water"},{id:"7",libelle:"Chauss√©e d√©grad√©e",icon_color:"red-white",icon_symbol:"checkered"}];function q(){const t=f(!1),o=f(null),i=f([]),b=async()=>{var e;if(!g.currentUser){console.log("üîê Connexion anonyme...");try{await z(g),console.log("‚úÖ Utilisateur anonyme connect√©:",(e=g.currentUser)==null?void 0:e.uid)}catch(n){throw console.error("‚ùå Erreur authentification:",n),(n==null?void 0:n.code)==="auth/operation-not-allowed"?new Error("L'authentification anonyme n'est pas activ√©e dans Firebase > Authentication > Sign-in method. Activez-la ou connectez-vous avant de cr√©er un signalement."):n}}},E=async()=>{try{const e=c(u,"signalementTypes"),n=await d(e);if(n.size>0)return console.log("‚úÖ Types d√©j√† existants:",n.size),!0;console.log("üìù Cr√©ation des types...");for(const s of v)await N(C(e,s.id),s),console.log(`‚úÖ Type cr√©√©: ${s.libelle}`);return console.log("‚úÖ Tous les types initialis√©s"),!0}catch(e){return console.error("‚ùå Erreur seed:",e),!1}},_=async()=>{console.log("üìÇ loadSignalementTypes appel√©e..."),t.value=!0,o.value=null;try{await E();const e=c(u,"signalementTypes");console.log("üì° R√©cup√©ration des types...");const n=await d(e);return console.log("üìä Snapshot re√ßu, nombre de docs:",n.size),i.value=n.docs.map(s=>({id:s.data().id||s.id,docId:s.id,...s.data()})),console.log("‚úÖ Types charg√©s:",i.value),console.log("Nombre de types:",i.value.length),i.value}catch(e){return console.error("‚ùå Erreur lors du chargement des types:",e),i.value=v,o.value=e.message||"Erreur lors du chargement des types",i.value}finally{t.value=!1}},M=async e=>{t.value=!0,o.value=null;try{await b();const n=g.currentUser;if(!n)throw new Error("Vous devez √™tre connect√© pour cr√©er un signalement");if(!e.latitude||!e.longitude)throw new Error("La localisation est obligatoire");if(!e.typeId)throw new Error("Le type de signalement est obligatoire");if(!e.description||e.description.trim().length<10)throw new Error("La description doit contenir au moins 10 caract√®res");if(e.surfaceM2!==null&&e.surfaceM2!==void 0){const a=parseFloat(e.surfaceM2);if(isNaN(a)||a<0)throw new Error("La surface doit √™tre un nombre positif")}if(e.budget!==null&&e.budget!==void 0){const a=parseFloat(e.budget);if(isNaN(a)||a<0)throw new Error("Le budget doit √™tre un nombre positif")}const s={latitude:parseFloat(e.latitude),longitude:parseFloat(e.longitude),addressComplement:e.addressComplement||null,typeId:e.typeId,description:e.description.trim(),surfaceM2:e.surfaceM2!==null&&e.surfaceM2!==void 0?parseFloat(e.surfaceM2):null,budget:e.budget!==null&&e.budget!==void 0?parseFloat(e.budget):null,entrepriseConcernee:e.entrepriseConcernee||null,userId:n.uid,userEmail:n.email||null,userName:n.displayName||null,isAnonymous:e.isAnonymous||!1,photos:e.photos&&e.photos.length>0?e.photos.map((a,m)=>({id:`photo_${m}_${Date.now()}`,dataUrl:a.dataUrl||a,uploadedAt:L.now()})):[],status:"nouveau",dateSignalement:new Date().toISOString(),createdAt:w(),updatedAt:w()},r=await U(c(u,"signalements"),s);return console.log("Signalement cr√©√© avec succ√®s:",r.id),{success:!0,id:r.id,data:s}}catch(n){throw console.error("Erreur lors de la cr√©ation du signalement:",n),o.value=n.message||"Erreur lors de la cr√©ation du signalement",n}finally{t.value=!1}},S=async()=>{t.value=!0,o.value=null;try{const e=g.currentUser;if(!e)throw new Error("Vous devez √™tre connect√©");const n=h(c(u,"signalements"),y("userId","==",e.uid));return(await d(n)).docs.map(r=>({id:r.id,...r.data()}))}catch(e){throw console.error("Erreur lors de la r√©cup√©ration des signalements:",e),o.value=e.message,e}finally{t.value=!1}},I=async e=>{t.value=!0,o.value=null;try{const n=h(c(u,"signalements"),y("__name__","==",e)),s=await d(n);if(s.empty)throw new Error("Signalement non trouv√©");const r=s.docs[0];return{id:r.id,...r.data()}}catch(n){throw console.error("Erreur lors de la r√©cup√©ration du signalement:",n),o.value=n.message,n}finally{t.value=!1}},T=async(e,n,s=5)=>{t.value=!0,o.value=null;try{const r=h(c(u,"signalements"),y("status","==","nouveau"));return(await d(r)).docs.map(l=>({id:l.id,...l.data()})).filter(l=>A(e,n,l.latitude,l.longitude)<=s)}catch(r){throw console.error("Erreur lors de la recherche par zone:",r),o.value=r.message,r}finally{t.value=!1}},A=(e,n,s,r)=>{const m=(s-e)*Math.PI/180,l=(r-n)*Math.PI/180,p=Math.sin(m/2)*Math.sin(m/2)+Math.cos(e*Math.PI/180)*Math.cos(s*Math.PI/180)*Math.sin(l/2)*Math.sin(l/2);return 6371*(2*Math.atan2(Math.sqrt(p),Math.sqrt(1-p)))};return{isLoading:t,error:o,signalementTypes:i,loadSignalementTypes:_,createSignalement:M,getUserSignalements:S,getSignalementById:I,getSignalementsByZone:T,getAllSignalements:async()=>{t.value=!0,o.value=null;try{return(await d(c(u,"signalements"))).docs.map(s=>({id:s.id,...s.data()})).filter(s=>!s._isExample)}catch(e){throw console.error("Erreur lors de la r√©cup√©ration des signalements:",e),o.value=e.message,e}finally{t.value=!1}}}}export{q as u};
