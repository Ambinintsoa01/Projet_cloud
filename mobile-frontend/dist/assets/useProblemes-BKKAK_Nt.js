import{u as j,at as I,au as p,av as E,aw as b,ax as y,ay as q,az as g,aA as R,aB as h,aC as U,aD as A,aE as P,y as w}from"./index-vCZlUi6s.js";function z(){const n=w(!1),u=w(null),v=w([]),m=j(),x=async()=>{var e,t;if(!((e=m.user)!=null&&e.id))throw console.error("‚ùå Utilisateur non connect√© au backend"),new Error("Veuillez vous connecter d'abord");if(console.log("‚úÖ Utilisation de l'ID utilisateur backend:",m.user.id),!y.currentUser)try{(t=m.user)!=null&&t.email&&console.log("üîê Connexion Firebase Auth avec email:",m.user.email)}catch(r){console.warn("‚ö†Ô∏è Firebase Auth non connect√© (non bloquant):",r.message)}return{uid:m.user.id.toString()}};return{isLoading:n,error:u,problemes:v,createProbleme:async e=>{n.value=!0,u.value=null;try{const r=(await x()).uid,a={userId:parseInt(r),latitude:e.latitude,longitude:e.longitude,description:e.description,typeId:e.typeId||null,status:"ouvert",createdAt:b(),updatedAt:b()};console.log("üìù Cr√©ation du probl√®me avec userId:",r),console.log("üìã Donn√©es:",a);const s=g(p,"problemes"),l=await R(s,a);return console.log("‚úÖ Probl√®me cr√©√© avec ID Firestore:",l.id),{id:l.id,...a,success:!0}}catch(t){throw console.error("‚ùå Erreur cr√©ation probl√®me:",t),u.value=t.message,t}finally{n.value=!1}},listProblemes:async()=>{n.value=!0,u.value=null;try{const e=g(p,"problemes"),t=h(e,A("createdAt","desc")),r=await P(t);return v.value=r.docs.filter(a=>!a.data()._isExample).map(a=>{var s,l,c,o;return{id:a.id,...a.data(),createdAt:((l=(s=a.data().createdAt)==null?void 0:s.toDate)==null?void 0:l.call(s))||null,updatedAt:((o=(c=a.data().updatedAt)==null?void 0:c.toDate)==null?void 0:o.call(c))||null}}),console.log("‚úÖ Probl√®mes charg√©s:",v.value.length),v.value}catch(e){return console.error("‚ùå Erreur chargement probl√®mes:",e),u.value=e.message,[]}finally{n.value=!1}},listOpenProblemes:async()=>{n.value=!0,u.value=null;try{const e=g(p,"problemes"),t=h(e,U("status","==","ouvert"),A("createdAt","desc")),a=(await P(t)).docs.filter(s=>!s.data()._isExample).map(s=>{var l,c,o,i;return{id:s.id,...s.data(),createdAt:((c=(l=s.data().createdAt)==null?void 0:l.toDate)==null?void 0:c.call(l))||null,updatedAt:((i=(o=s.data().updatedAt)==null?void 0:o.toDate)==null?void 0:i.call(o))||null}});return console.log("‚úÖ Probl√®mes ouverts:",a.length),a}catch(e){return console.error("‚ùå Erreur chargement probl√®mes ouverts:",e),u.value=e.message,[]}finally{n.value=!1}},listMyProblemes:async()=>{var e,t;n.value=!0,u.value=null;try{const r=((e=m.user)==null?void 0:e.id)||((t=y.currentUser)==null?void 0:t.uid);if(!r)return console.warn("‚ö†Ô∏è Utilisateur non connect√©"),[];const a=g(p,"problemes"),s=h(a,U("userId","==",r),A("createdAt","desc")),c=(await P(s)).docs.filter(o=>!o.data()._isExample).map(o=>{var i,f,d,D;return{id:o.id,...o.data(),createdAt:((f=(i=o.data().createdAt)==null?void 0:i.toDate)==null?void 0:f.call(i))||null,updatedAt:((D=(d=o.data().updatedAt)==null?void 0:d.toDate)==null?void 0:D.call(d))||null}});return console.log("‚úÖ Mes probl√®mes:",c.length),c}catch(r){return console.error("‚ùå Erreur chargement mes probl√®mes:",r),u.value=r.message,[]}finally{n.value=!1}},convertProbleme:async(e,t)=>{var r,a;n.value=!0,u.value=null;try{const s=((r=m.user)==null?void 0:r.id)||((a=y.currentUser)==null?void 0:a.uid)||"anonymous",l=I(p,"problemes",e),c=await q(l);if(!c.exists())throw new Error("Probl√®me introuvable");const o=c.data(),i={latitude:o.latitude,longitude:o.longitude,typeId:t.typeId,description:t.description||o.description,surfaceM2:t.surfaceM2||null,budget:t.budget||null,entrepriseConcernee:t.entrepriseConcernee||null,isAnonymous:!1,status:"nouveau",userId:s,createdBy:"conversion",problemeId:e,createdAt:b(),updatedAt:b()},f=g(p,"signalements"),d=await R(f,i);return console.log("‚úÖ Signalement cr√©√©:",d.id),await E(l,{status:"converti",signalementId:d.id,updatedAt:b()}),console.log("‚úÖ Probl√®me marqu√© comme converti"),{id:d.id,...i,success:!0}}catch(s){throw console.error("‚ùå Erreur conversion probl√®me:",s),u.value=s.message,s}finally{n.value=!1}},rejectProbleme:async(e,t=null)=>{n.value=!0,u.value=null;try{const r=I(p,"problemes",e);await E(r,{status:"rejete",rejectionReason:t,updatedAt:b()}),console.log("‚úÖ Probl√®me rejet√©")}catch(r){throw console.error("‚ùå Erreur rejet probl√®me:",r),u.value=r.message,r}finally{n.value=!1}}}}export{z as u};
